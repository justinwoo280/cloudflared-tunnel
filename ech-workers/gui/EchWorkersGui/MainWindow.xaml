<Window x:Class="EchWorkersGui.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="ECH Workers" Height="720" Width="1100"
        WindowStartupLocation="CenterScreen"
        Icon="/Resources/app.ico">
  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="*"/>
      <RowDefinition Height="220"/>
    </Grid.RowDefinitions>
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="280"/>
      <ColumnDefinition Width="*"/>
    </Grid.ColumnDefinitions>

    <Border Grid.Row="0" Grid.Column="0" BorderBrush="#2D2D30" BorderThickness="0,0,1,0" Padding="12">
      <DockPanel LastChildFill="True">
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,10">
          <Button Content="添加" Width="64" Margin="0,0,8,0" Command="{Binding AddNodeCommand}"/>
          <Button Content="删除" Width="64" Margin="0,0,8,0" Command="{Binding DeleteNodeCommand}" IsEnabled="{Binding HasSelectedNode}"/>
          <Button Content="保存" Width="64" Command="{Binding SaveAllCommand}"/>
        </StackPanel>

        <ListBox ItemsSource="{Binding Nodes}" SelectedItem="{Binding SelectedNode}" DisplayMemberPath="Name"/>
      </DockPanel>
    </Border>

    <Border Grid.Row="0" Grid.Column="1" Padding="12">
      <DockPanel LastChildFill="True">
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,10">
          <Button Content="启动" Width="80" Margin="0,0,8,0" Command="{Binding StartCoreCommand}" IsEnabled="{Binding CanStart}"/>
          <Button Content="停止" Width="80" Margin="0,0,8,0" Command="{Binding StopCoreCommand}" IsEnabled="{Binding CanStop}"/>
          <TextBlock VerticalAlignment="Center" Text="{Binding StatusText}"/>
        </StackPanel>

        <TabControl>
          <TabItem Header="节点配置">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
              <Grid Margin="8">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="160"/>
                  <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Grid.Column="0" Margin="0,0,10,8" Text="名称"/>
                <TextBox Grid.Row="0" Grid.Column="1" Margin="0,0,0,8" Text="{Binding SelectedNode.Name, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="1" Grid.Column="0" Margin="0,0,10,8" Text="服务器地址"/>
                <TextBox Grid.Row="1" Grid.Column="1" Margin="0,0,0,8" Text="{Binding SelectedNode.ServerAddr, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="2" Grid.Column="0" Margin="0,0,10,8" Text="服务器 IP(可选)"/>
                <TextBox Grid.Row="2" Grid.Column="1" Margin="0,0,0,8" Text="{Binding SelectedNode.ServerIp, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="3" Grid.Column="0" Margin="0,0,10,8" Text="Token/UUID"/>
                <TextBox Grid.Row="3" Grid.Column="1" Margin="0,0,0,8" Text="{Binding SelectedNode.Token, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="4" Grid.Column="0" Margin="0,0,10,8" Text="协议"/>
                <ComboBox Grid.Row="4" Grid.Column="1" Margin="0,0,0,8" SelectedValue="{Binding SelectedNode.ProtoMode}" SelectedValuePath="Tag">
                  <ComboBoxItem Content="WebSocket" Tag="ws"/>
                  <ComboBoxItem Content="gRPC" Tag="grpc"/>
                </ComboBox>

                <TextBlock Grid.Row="5" Grid.Column="0" Margin="0,0,10,8" Text="并发连接数"/>
                <TextBox Grid.Row="5" Grid.Column="1" Margin="0,0,0,8" Text="{Binding SelectedNode.NumConns, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="6" Grid.Column="0" Margin="0,0,10,8" Text="启用 Yamux"/>
                <CheckBox Grid.Row="6" Grid.Column="1" Margin="0,0,0,8" IsChecked="{Binding SelectedNode.EnableYamux}" ToolTip="启用 Yamux 多路复用（需要 Go 服务端）；关闭后兼容 Cloudflare Workers"/>

                <TextBlock Grid.Row="7" Grid.Column="0" Margin="0,0,10,8" Text="启用 ECH"/>
                <CheckBox Grid.Row="7" Grid.Column="1" Margin="0,0,0,8" IsChecked="{Binding SelectedNode.EnableEch}"/>

                <TextBlock Grid.Row="8" Grid.Column="0" Margin="0,0,10,8" Text="ECH 查询域名"/>
                <TextBox Grid.Row="8" Grid.Column="1" Margin="0,0,0,8" Text="{Binding SelectedNode.EchDomain, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="9" Grid.Column="0" Margin="0,0,10,8" Text="DoH 服务器"/>
                <TextBox Grid.Row="9" Grid.Column="1" Margin="0,0,0,8" Text="{Binding SelectedNode.DnsServer, UpdateSourceTrigger=PropertyChanged}"/>

                <Button Grid.Row="10" Grid.Column="1" HorizontalAlignment="Left" Width="120" Content="保存节点" Command="{Binding SaveAllCommand}"/>
              </Grid>
            </ScrollViewer>
          </TabItem>

          <TabItem Header="全局配置">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
              <Grid Margin="8">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="160"/>
                  <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Grid.Column="0" Margin="0,0,10,8" Text="内核路径"/>
                <Grid Grid.Row="0" Grid.Column="1" Margin="0,0,0,8">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                  </Grid.ColumnDefinitions>
                  <TextBox Grid.Column="0" Text="{Binding Global.CorePath, UpdateSourceTrigger=PropertyChanged}"/>
                  <Button Grid.Column="1" Content="浏览..." Width="60" Margin="8,0,0,0" Command="{Binding BrowseCorePathCommand}"/>
                </Grid>

                <TextBlock Grid.Row="1" Grid.Column="0" Margin="0,0,10,8" Text="监听地址"/>
                <TextBox Grid.Row="1" Grid.Column="1" Margin="0,0,0,8" Text="{Binding Global.ListenAddr, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="2" Grid.Column="0" Margin="0,0,10,8" Text="自动配置系统代理"/>
                <CheckBox Grid.Row="2" Grid.Column="1" Margin="0,0,0,8" IsChecked="{Binding Global.EnableSysProxy}"/>

                <TextBlock Grid.Row="3" Grid.Column="0" Margin="0,0,10,8" Text="启用 TUN"/>
                <CheckBox Grid.Row="3" Grid.Column="1" Margin="0,0,0,8" IsChecked="{Binding Global.EnableTun}"/>

                <TextBlock Grid.Row="4" Grid.Column="0" Margin="0,0,10,8" Text="TUN IP"/>
                <TextBox Grid.Row="4" Grid.Column="1" Margin="0,0,0,8" Text="{Binding Global.TunIp, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="5" Grid.Column="0" Margin="0,0,10,8" Text="TUN 网关"/>
                <TextBox Grid.Row="5" Grid.Column="1" Margin="0,0,0,8" Text="{Binding Global.TunGateway, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="6" Grid.Column="0" Margin="0,0,10,8" Text="TUN 掩码"/>
                <TextBox Grid.Row="6" Grid.Column="1" Margin="0,0,0,8" Text="{Binding Global.TunMask, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="7" Grid.Column="0" Margin="0,0,10,8" Text="TUN DNS"/>
                <TextBox Grid.Row="7" Grid.Column="1" Margin="0,0,0,8" Text="{Binding Global.TunDns, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="8" Grid.Column="0" Margin="0,0,10,8" Text="TUN MTU"/>
                <TextBox Grid.Row="8" Grid.Column="1" Margin="0,0,0,8" Text="{Binding Global.TunMtu, UpdateSourceTrigger=PropertyChanged}"/>
              </Grid>
            </ScrollViewer>
          </TabItem>
        </TabControl>
      </DockPanel>
    </Border>

    <Border Grid.Row="1" Grid.ColumnSpan="2" BorderBrush="#2D2D30" BorderThickness="0,1,0,0" Padding="12">
      <DockPanel>
        <TextBlock DockPanel.Dock="Top" Text="日志" Margin="0,0,0,8"/>
        <TextBox Text="{Binding LogText, Mode=OneWay}" IsReadOnly="True" FontFamily="Consolas" TextWrapping="NoWrap" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto"/>
      </DockPanel>
    </Border>
  </Grid>
</Window>
